@model TravelBooking.Web.ViewModels.Payments.TourPaymentViewModel
@{
    ViewData["Title"] = "Secure Payment";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var userCurrency = ViewBag.SelectedCurrency as string ?? CookieHelper.GetCurrency();
    // Model.Currency is already set to selected currency from cookie, so no conversion needed
    // But for safety, ensure values are in user currency
    var convertedPrice = CurrencyHelper.ConvertPrice(Model.Price, Model.Currency ?? "TRY", userCurrency);
    var convertedSubtotal = CurrencyHelper.ConvertPrice(Model.Subtotal, Model.Currency ?? "TRY", userCurrency);
    var convertedTax = CurrencyHelper.ConvertPrice(Model.Tax, Model.Currency ?? "TRY", userCurrency);
    var convertedTotal = CurrencyHelper.ConvertPrice(Model.Total, Model.Currency ?? "TRY", userCurrency);
}

<!-- Title-Banner Start -->
<div class="title-banner mb-20">
    <div class="container-fluid">
        <div class="row">
            <div class="banner-area">
                <img src="~/assets/img/vacation.svg" alt="" class="left-image">
                <div class="content-box">
                    <h1 class="fw-700 lightest-black">Secure <br class="title-break"> Payment</h1>
                </div>
                <span class="right-image right-image-icon" aria-hidden="true"><i class="icon-map-marker"></i></span>
            </div>
        </div>
    </div>
</div>
<!-- Title-Banner End -->

<!-- Main Content Start -->
<div class="page-content m-0">
    <section class="flight-booking" data-sal="slide-up" data-sal-duration="800" data-sal-delay="100" data-sal-easing="ease-in-out">
        <div class="container-fluid">
            <div class="row">
                <div class="col-xl-8">
                    <div class="booking-form">
                        <form asp-controller="Tour" asp-action="CompletePayment" method="post">
                            @Html.AntiForgeryToken()
                            
                            <!-- Hidden fields to pass tour info (only TourRawId - TourId derived server-side to avoid Guidâ†’int binding error) -->
                            <input type="hidden" asp-for="TourRawId" />
                            <input type="hidden" asp-for="TourName" />
                            <input type="hidden" asp-for="Destination" />
                            <input type="hidden" asp-for="Duration" />
                            <input type="hidden" asp-for="TourDate" />
                            <input type="hidden" asp-for="ParticipantCount" />
                            <input type="hidden" asp-for="Price" />
                            <input type="hidden" asp-for="Currency" />
                            <input type="hidden" asp-for="ContactName" />
                            <input type="hidden" asp-for="ContactEmail" />
                            <input type="hidden" asp-for="ContactPhone" />

                            @await Html.PartialAsync("_ValidationSummary")

                            <!-- Iletisim Bilgileri -->
                            <div class="detail-form p-24 bg-white shadow-sm br-12 border mb-32">
                                <h4 class="black p-0 mb-24">
                                    <i class="fa fa-user me-2"></i>
                                    Iletisim Bilgileri
                                </h4>
                                <div class="row">
                                    <div class="col-sm-4">
                                        <p class="mb-2"><strong>Ad Soyad:</strong></p>
                                        <p class="text-muted">@Model.ContactName</p>
                                    </div>
                                    <div class="col-sm-4">
                                        <p class="mb-2"><strong>Email:</strong></p>
                                        <p class="text-muted">@Model.ContactEmail</p>
                                    </div>
                                    <div class="col-sm-4">
                                        <p class="mb-2"><strong>Telefon:</strong></p>
                                        <p class="text-muted">@Model.ContactPhone</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Payment Form Partial -->
                            @await Html.PartialAsync("~/Views/Shared/Partials/_PaymentForm.cshtml", Model)

                            <div class="form-wizard-footer">
                                <a asp-controller="Tour" asp-action="Booking" asp-route-tourId="@Model.TourRawId" 
                                   class="btn btn-secondary btn-lg me-3">
                                    <i class="fa fa-arrow-left me-2"></i>
                                    Back to Booking
                                </a>
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fa fa-lock me-2"></i>
                                    Complete Payment
                                </button>
                            </div>
                            <hr class="my-4" />
                            <div class="mb-3">
                                <p class="text-muted small mb-2">Or pay securely with Stripe:</p>
                                <form asp-controller="Stripe" asp-action="CreateCheckoutSession" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="AmountKurus" value="@((long)Math.Round(Model.Total * 100))" />
                                    <input type="hidden" name="Currency" value="@(Model.Currency?.ToLowerInvariant() ?? "try")" />
                                    <input type="hidden" name="ProductName" value="Tour: @Model.TourName" />
                                    <button type="submit" class="btn btn-outline-primary btn-lg">
                                        <i class="fab fa-stripe me-2"></i>Pay with Stripe
                                    </button>
                                </form>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="col-xl-4">
                    <div class="flight-booking-detail light-shadow">
                        <div class="flight-title">
                            <h4 class="color-black">Order Summary</h4>
                        </div>
                        <div class="content-block bg-white p-24 light-shadow">
                            <h5 class="color-black mb-16">@Model.TourName</h5>
                            <p class="dark-gray mb-24">
                                <i class="fa fa-map-marker-alt me-2"></i>
                                @Model.Destination
                            </p>
                            
                            <div class="d-flex justify-content-between mb-16">
                                <span class="light-black">
                                    <i class="fa fa-calendar me-2"></i>
                                    Tour Date:
                                </span>
                                <span class="light-black">@Model.TourDate.ToString("MMM dd, yyyy")</span>
                            </div>
                            
                            <div class="d-flex justify-content-between mb-16">
                                <span class="light-black">
                                    <i class="fa fa-clock me-2"></i>
                                    Duration:
                                </span>
                                <span class="light-black">@Model.Duration days</span>
                            </div>
                            
                            <div class="d-flex justify-content-between mb-16">
                                <span class="light-black">
                                    <i class="fa fa-users me-2"></i>
                                    Participants:
                                </span>
                                <span class="light-black">@Model.ParticipantCount</span>
                            </div>
                            
                            <div class="d-flex justify-content-between mb-16">
                                <span class="light-black">Price per person:</span>
                                <span class="light-black">@CurrencyHelper.FormatPrice(convertedPrice, userCurrency)</span>
                            </div>
                            
                            <div class="d-flex justify-content-between mb-16">
                                <span class="light-black">Subtotal:</span>
                                <span class="light-black">@CurrencyHelper.FormatPrice(convertedSubtotal, userCurrency)</span>
                            </div>
                            
                            <div class="d-flex justify-content-between mb-24">
                                <span class="light-black">Tax (10%):</span>
                                <span class="light-black">@CurrencyHelper.FormatPrice(convertedTax, userCurrency)</span>
                            </div>
                            
                            <div class="border-top pt-16">
                                <div class="d-flex justify-content-between">
                                    <h5 class="color-black">Toplam:</h5>
                                    <h5 class="color-primary">@CurrencyHelper.FormatPrice(convertedTotal, userCurrency)</h5>
                                </div>
                            </div>

                            <div class="alert alert-info mt-3" role="alert">
                                <i class="fa fa-info-circle me-2"></i>
                                <small>Confirmation email will be sent after payment is processed.</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")
}
